name: Deploy dev stage

on:
  push:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "Commit SHA to deploy"
        required: false
        default: "latest"
        type: string

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "21"

      # Локальные билды отключены, проверка в PR
      # - name: Install & build backend locally
      #   working-directory: apps/backend
      #   run: |
      #     npm install
      #     npx prisma generate
      #     npm run build
      #
      # - name: Install & build admin locally
      #   working-directory: apps/admin
      #   run: |
      #     npm install
      #     npm run admin:build

      - name: Add SSH key to ssh-agent
        run: |
          mkdir -p ~/.ssh
          echo "$DEV_SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519
        env:
          DEV_SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_PRIVATE_KEY }}

      - name: Deploy to Server
        run: |
          ssh-keyscan -H "$DEV_SSH_HOST" >> ~/.ssh/known_hosts
          ssh "$DEV_SSH_USER@$DEV_SSH_HOST" << EOF
            set -e
            cd /home/soul_backend/backend
            git pull origin dev
            COMMIT_SHA="${COMMIT_SHA:-$(git rev-parse HEAD)}"
            git checkout "$COMMIT_SHA"

            cd apps/backend
            npm ci
            npx prisma generate
            npm run build

            cd ../admin
            npm ci
            npm run admin:build

            cd ../..
            docker network inspect backend-net || docker network create backend-net
            docker compose -f docker-compose.deploy.yml up -d db
            docker compose -f docker-compose.deploy.yml up -d --build migrate
            docker compose -f docker-compose.deploy.yml up -d --build backend admin
            docker image prune -a -f
            docker builder prune -f
            node deploy-health-check.js 
          EOF
        env:
          DEV_SSH_USER: ${{ secrets.DEV_SSH_USER }}
          DEV_SSH_HOST: ${{ secrets.DEV_SSH_HOST }}
          COMMIT_SHA: ${{ github.event.inputs.commit_sha || github.sha }}
